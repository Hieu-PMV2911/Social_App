(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3577],{17381:function(e,t,n){"use strict";n.d(t,{Z:function(){return o}});var r=n(66700),i=n(19785);function o(e){return(0,i.Z)(1,arguments),Math.floor(function(e){return(0,i.Z)(1,arguments),(0,r.Z)(e).getTime()}(e)/1e3)}},91715:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/auth/sign-in",function(){return n(58183)}])},52012:function(e,t,n){"use strict";n.d(t,{My:function(){return g},Qb:function(){return m},p9:function(){return h}});var r=n(98788),i=n(50853),o=n(5632),u=/*#__PURE__*/n.n(o),a=n(42541),c=n(90581),s=n(17381),l=n(99669),f={defaultTTL:86400},d=new/*#__PURE__*/(function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f;(0,c.Z)(this,e),this._storage=t,this._options=n}var t=e.prototype;return t.setItem=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._options.defaultTTL,r=(0,s.Z)(new Date);this._storage.setItem(e,{value:t,exp:r+n})},t.getItem=function(e){var t=this._storage.getItem(e);if(null==t||"object"!=typeof t)return t;if(!Reflect.has(t,"value")||!Reflect.has(t,"exp"))return console.warn('ExpiryLocalStorage.getItem("'.concat(e,'") - data is malformed'),t),null;var n=(0,s.Z)(new Date);return n>t.exp?(console.debug('ExpiryLocalStorage.getItem("'.concat(e,'") - data has expired ').concat(n-t.exp," seconds ago")),this._storage.removeItem(e),null):t.value},t.removeItem=function(e){this._storage.removeItem(e)},t.clear=function(){this._storage.clear()},e}())(l.J),p="auth/redirect";function h(e){d.setItem(p,e,900)}function g(){return d.getItem(p)}function m(e,t){return v.apply(this,arguments)}function v(){return(v=(0,r.Z)(function(e,t){var n;return(0,i.__generator)(this,function(r){switch(r.label){case 0:if(n=g(),console.debug("Redirect to ".concat(null!=n?n:e)),!n)return[3,2];return d.removeItem(p),a.Z.trackEvent("login-page","redirect_to_saved_path",{source:t,url:n,workspaceId:n.split("/")[2]}),[4,u().replace(n)];case 1:return r.sent(),[3,4];case 2:return[4,u().replace(e)];case 3:r.sent(),r.label=4;case 4:return[2]}})})).apply(this,arguments)}},66464:function(e,t,n){"use strict";n.d(t,{i:function(){return O}});var r,i,o=n(87394),u=n(2784),a=n(5632),c=/*#__PURE__*/n.n(a),s=n(20810),l=n(39739),f=n(69904),d=n(68594),p=n(82808),h=n(35120),g=n(12335),m=n(11348),v=n(77984),_=n(52012),w=n(57821),y=n(57685),b=n(57335),I=n(98788),A=n(50853),N=n(97594),T=n(10186),Z=(r=(0,I.Z)(function(e){return(0,A.__generator)(this,function(t){switch(t.label){case 0:return[4,T.Z.teams.withConverter(N.ML).where("isAutoJoinEnabled","==",!0).where("domain","==",e).get()];case 1:return[2,t.sent().docs.map(function(e){return e.data()})]}})}),function(e){return r.apply(this,arguments)}),R=(i=(0,I.Z)(function(e){return(0,A.__generator)(this,function(t){switch(t.label){case 0:return[4,T.Z.userTeams(e).limit(1).get()];case 1:return[2,!t.sent().empty]}})}),function(e){return i.apply(this,arguments)}),E=["website","notion","integration","diagramgpt","chatgpt","sourcegraph-cody"],C=n(10097),U=n(53220),P=n(88218),x=n(24618),S=function(e){c().replace(e)},k=function(){return S("/team/create")};function O(){var e=(0,u.useState)(),t=e[0],n=e[1],r=(0,u.useState)({}),i=r[0],a=r[1],I=(0,y.K)(),A=(0,u.useRef)({redirect:"",isRedirecting:!1});(0,f.Z)(function(){var e=c().query.redirect;"string"==typeof e&&((0,_.p9)(e),A.current.redirect=e)}),(0,u.useEffect)(function(){var e,t,n,r;a((t=(e=I).ref,n=e.utm_campaign,r=e.templateId,n?{signUpOrigin:"paid",signUpCampaign:n}:r?{signUpOrigin:"website",signUpTemplate:r}:{signUpOrigin:"string"!=typeof t?"other":E.includes(t)?t:"other"}))},[I]);var N=(0,u.useCallback)(function(){c().prefetch("/dashboard/all"),c().prefetch("/dashboard/recents"),c().prefetch("/team/create"),c().prefetch("/team/join")},[]),T=(0,u.useCallback)(function(){c().query.redirect_uri===b.NOTION_INTEGRATION_REDIRECT_URL&&c().replace("/notion/auth?"+new URLSearchParams(c().query).toString())},[]),O=(0,u.useCallback)(function(e){console.info("[Auth Page] Something went wrong",e),(0,U.Tb)(e),n(e)},[]),L=(0,s.m)(function(){var e;return(e=C.I8,new d.y(function(t){return{unsubscribe:e.onAuthStateChanged(t)}})).pipe((0,g.w)(function(e){return(0,p.s)(function(){return e&&!e.isAnonymous&&e.providerData.length>0},(0,h.of)(e).pipe((0,m.b)(function(e){return console.info("[Auth Page] User signed in:",{uid:e.uid,email:e.email,isAnonymous:e.isAnonymous,displayName:e.displayName})}),(0,m.b)(T),(0,m.b)(N),(0,m.b)(function(){var e=A.current.redirect;if(null==e?void 0:e.match("/new")){var t,n=(null===(t=c().asPath)||void 0===t?void 0:t.match("sign-up"))?"sign-up":"sign-in";(0,_.Qb)("/dashboard/all",n),A.current.isRedirecting=!0}}),(0,g.w)(function(e){return R(e.uid)}),(0,x.VK)(),(0,g.w)(function(t){return!t&&e.email&&e.emailVerified&&!A.current.isRedirecting?(0,h.of)((0,P.ZP)(e.email)).pipe((0,g.w)(function(e){return Z(e)}),(0,x.VK)(),(0,v.U)(function(e){return[t,e]})):(0,h.of)([t,[]])}),(0,m.b)(function(t){var n=(0,o.Z)(t,2),r=n[0],i=n[1];if(!A.current.isRedirecting){if(r){console.info("[Auth Page] User has team, redirect to ...");var u,a=(null===(u=c().asPath)||void 0===u?void 0:u.match("sign-up"))?"sign-up":"sign-in";(0,_.Qb)("/dashboard/all",a)}else e.email?(console.info("[Auth Page] User has ".concat(i.length," teams with the same domain")),i.length>0?S("/team/join"):k()):(console.info("[Auth Page] User doesn't have email, redirect to team create"),k())}})),(0,h.of)(e).pipe((0,m.b)(function(e){return console.info("[Auth Page] User signed out:",{uid:null==e?void 0:e.uid,email:null==e?void 0:e.email,isAnonymous:null==e?void 0:e.isAnonymous,displayName:null==e?void 0:e.displayName})}),(0,m.b)(function(){return(0,w.hf)()})))}))});return(0,l.m)(L,void 0,O),{error:t,profileArgs:i}}},58183:function(e,t,n){"use strict";n.r(t),n.d(t,{__N_SSP:function(){return c}});var r=n(52322),i=n(58410),o=n(66464),u=n(70759),a=n(69023),c=!0;t.default=function(){var e=(0,o.i)(),t=e.error,n=e.profileArgs;return t?/*#__PURE__*/(0,r.jsx)(i.Z,{statusCode:500,title:"Something went wrong"}):"undefined"==typeof document?null:/*#__PURE__*/(0,r.jsx)(a.Z,{staticLogo:!0,children:/*#__PURE__*/(0,r.jsx)(u.o,{profileArgs:n})})}},57335:function(e,t,n){"use strict";n.r(t),n.d(t,{NOTION_INTEGRATION_REDIRECT_URL:function(){return f},default:function(){return d}});var r=n(52322),i=n(2784),o=n(94764),u=n(5632),a=n(58410),c=n(96933),s=n(85957),l=n(53220),f="https://www.notion.so/externalintegrationauthcallback",d=function(){var e=(0,u.useRouter)(),t=(0,c.fC)(),n=e.query.code,f=e.query.redirect_uri,d=e.query.state;return((0,i.useEffect)(function(){if(t&&n){if(null==t?void 0:t.isAnonymous){e.replace("/auth/sign-up?ref=notion&"+new URLSearchParams(e.query).toString());return}var r,i=(0,o.x0)();(r={notionAuthCode:n,tempAuthCode:i,userEmail:t.email,userDisplayName:t.displayName},(0,s.Z)("notion-retrieveToken",r)).then(function(e){if(null==e){location.replace(f+"?error=access_denied&error_description=Not+valid+access+token..");return}location.replace(f+"?code=".concat(i,"&state=").concat(d))}).catch(function(e){(0,l.Tb)(e),location.replace(f+"?error=access_denied&error_description=An+internal+server+error+occurred.")})}},[t,n,d,f,e]),f&&n&&d)?null:/*#__PURE__*/(0,r.jsx)(a.Z,{statusCode:400,title:"Not enough query parameters specified"})}}},function(e){var t=function(t){return e(e.s=t)};e.O(0,[2888],function(){return t(53078),t(91715)}),_N_E=e.O()}]);